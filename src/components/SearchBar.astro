---
import registryData from "../data/packages.json";

const packagesJson = JSON.stringify(registryData.packages);
---

<div class="relative" id="search-container">
  <div class="relative">
    <svg
      class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-grey-text"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
    <input
      id="search-input"
      type="text"
      placeholder="Search packages..."
      aria-label="Search packages"
      autocomplete="off"
      class="w-full pl-10 pr-4 py-2.5 bg-black-card border border-grey-border/30 rounded-lg text-sm text-white placeholder-grey-text focus:outline-none focus:border-red-accent/50 transition-colors"
    />
  </div>
</div>

<script define:vars={{ packagesJson }}>
  const packages = JSON.parse(packagesJson);

  async function initSearch() {
    const Fuse = (await import("fuse.js")).default;
    const fuse = new Fuse(packages, {
      keys: ["name", "description", "tags", "author"],
      threshold: 0.4,
    });

    const input = document.getElementById("search-input");
    if (!input) return;

    input.addEventListener("input", (e) => {
      const query = e.target.value.trim();
      if (!query) {
        window.dispatchEvent(new CustomEvent("search-filter", { detail: { matches: null } }));
        return;
      }

      const matches = fuse.search(query);
      const matchedNames = new Set(matches.map(({ item }) => item.name));
      window.dispatchEvent(new CustomEvent("search-filter", { detail: { matches: matchedNames } }));
    });
  }

  initSearch();
</script>
